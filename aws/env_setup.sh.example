#!/bin/bash

CURRENT_DIR=$(pwd)

function checkExecutionDirectory() {
  if [ ! -f "$1" ]; then
    echo "executing this script from the wrong directory, exiting..."
    exit 1
  fi
}
# you might want to rename the file being checked
checkExecutionDirectory "$CURRENT_DIR/env_setup.sh"

# see https://www.geeksforgeeks.org/histcontrol-command-in-linux-with-examples/
export HISTCONTROL=ignorespace

# Project related variables
 # port that the nodes participating in consensus protocol exchanges use to accept other nodes to connect
 export NODE_SERVING_PORT=33330
 # port that the kv stores use to accept clients to connect
 export CLIENT_SERVING_PORT=33331
 # reserve some more ports just in case
 export RESERVED_PORT_START=$NODE_SERVING_PORT
 export RESERVED_PORT_END=$((CLIENT_SERVING_PORT + 4))

# AWS credentials and properties
 export AWS_PROFILE=
 export AWS_DEFAULT_REGION=eu-west-1
 export AWS_DEFAULT_AVAILABILITY_ZONE=eu-west-1c
 export AWS_ACCESS_KEY=AKIA5Y6IAIFGLK3362HP
 export AWS_SECRET_KEY=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
 export AWS_AMI_NAME=ami-full-deps

# Terraform variables
 export TERRAFORM_WORKING_DIR=$CURRENT_DIR/provision
 export TF_VAR_reserved_port_start=$RESERVED_PORT_START
 export TF_VAR_reserved_port_end=$RESERVED_PORT_END
 export TF_VAR_aws_profile=$AWS_PROFILE
 export TF_VAR_aws_region=$AWS_DEFAULT_REGION
 export TF_VAR_aws_availability_zone=$AWS_DEFAULT_AVAILABILITY_ZONE
 export TF_VAR_aws_ec2_ami_name=$AWS_AMI_NAME

# Packer variables
 export PKR_VAR_aws_region=$AWS_DEFAULT_REGION
 export PKR_VAR_aws_availability_zone=$AWS_DEFAULT_AVAILABILITY_ZONE
 export PKR_VAR_aws_ec2_ami_name=$AWS_AMI_NAME

# Ansible variables
 export ANSIBLE_WORKING_DIR=$CURRENT_DIR/orchestrate
 export ANSIBLE_CONFIG=$ANSIBLE_WORKING_DIR/ansible.cfg
 export ANSIBLE_INVENTORY_FILE=$ANSIBLE_WORKING_DIR/inventory/aws_ec2_static.ini
 # if you change this variable, make sure you also update ./inventory/aws_ec2.yaml -> aws_profile argument.
 export ANSIBLE_AWS_PROFILE=ansible

function awsCredentialsSetup() {
    local awsUserDir=~/.aws
    local awsUserCredentialsFile=$awsUserDir/credentials

    if [ ! -d "$awsUserDir" ]; then
     echo "$awsUserDir directory doesn't exist, aws-cli is not properly configured?"
     return;
    fi

    local userInput="no"
    echo "[WARN]"
    echo "Ansible needs a dedicated profile in ~/.aws/credentials file.
    This step will append an [ansible] profile section in this file without modifying original contents of the file.
    If no properly configured aws profile is supplied, ansible will not be able to continue using aws plugins.
    If you skip this step, make sure you have a dedicated profile section and pass the name of the profile to
    AWS_PROFILE environment variable above."
    echo "Would you like to skip this step? [y/No]"
    read -r userInput

    if [ -z "$userInput" ]; then
     userInput='no'
    fi

    if [ "no" != "$userInput" ]; then
     return;
    fi

    if [ ! -f "$awsUserCredentialsFile" ]; then
     echo "[INFO] creating $awsUserCredentialsFile file"
     touch $awsUserCredentialsFile
    fi

    if grep -q "$ANSIBLE_AWS_PROFILE" "$awsUserCredentialsFile" ; then
      echo "[INFO] profile [$ANSIBLE_AWS_PROFILE] exists in $awsUserCredentialsFile, no modification done." ;
      return;
    fi

    local profileSection=$(cat <<EOF

[$ANSIBLE_AWS_PROFILE]
region=$AWS_DEFAULT_REGION
aws_access_key_id=$AWS_ACCESS_KEY
aws_secret_access_key=$AWS_SECRET_KEY
EOF
)

    echo "$profileSection" >> $awsUserCredentialsFile
    echo "[INFO] created [$ANSIBLE_AWS_PROFILE] profile in $awsUserCredentialsFile." ;
}

# at the moment, we are not currently relying on aws plugins, therefore this function won't run
#awsCredentialsSetup